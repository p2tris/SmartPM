<!DOCTYPE html>
<html lang="en">
<head>


<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SmartPM map tool</title>

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">


<script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyDY0kkJiTPVd2U7aTOAwhc9ySH6oHxOIYM&sensor=false"> </script>

<script>
var map;
var myCenter=new google.maps.LatLng(41.89092091793598,12.503621578216553);
var markers = {};
var polys = {};

function initialize()
{
var mapProp = {
  center:myCenter,
  zoom:14,
  mapTypeId:google.maps.MapTypeId.ROADMAP
  };

  map = new google.maps.Map(document.getElementById("googleMap"),mapProp);

  google.maps.event.addListener(map, 'click', function(event) {
    placeMarker(event.latLng);
  });
}

var points = 0;
var fstLat = 0;
var fstLon = 0;
var sndLat = 0;
var sndLon = 0;

function placeMarker(location) {

	points += 1;
	if(points % 2 == 0) {
		if(fstLat > location.lat() && fstLon < location.lng()){
			sndLat = location.lat();
			sndLon = location.lng();
			
			var marker = new google.maps.Marker({
				position: location,
				map: map,
			});
			
			markers[sndLat + '_' + sndLon] = marker; // cache marker in markers object
			
			var squareCoords = [
				new google.maps.LatLng(fstLat, fstLon),
				new google.maps.LatLng(sndLat, fstLon),
				new google.maps.LatLng(sndLat, sndLon),
				new google.maps.LatLng(fstLat, sndLon)
			];
			
			// Construct the polygon.
			squareElem = new google.maps.Polygon({
				paths: squareCoords,
				strokeColor: '#FF0000',
				strokeOpacity: 0.8,
				strokeWeight: 3,
				fillColor: '#FF0000',
				fillOpacity: 0.35
			});
			
			polys[fstLat + '_' + fstLon] = squareElem;

			squareElem.setMap(map);
			
			addRow(fstLat, fstLon, sndLat, sndLon);
		} else {
			alert("Second point must be bottomright point of the box!");
			points -= 1;
		}
		
	} else {
		
		var marker = new google.maps.Marker({
			position: location,
			map: map,
		});
		fstLat = location.lat();
		fstLon = location.lng();
		markers[fstLat + '_' + fstLon] = marker; // cache marker in markers object
	}
}
function addRow(topLat, topLon, botLat, botLon) {
          
    var table = document.getElementById("LocList");
 
    var rowCount = table.rows.length;
    var row = table.insertRow(rowCount);
 
	row.insertCell(0).innerHTML= '<input type="button" value = "Delete" onClick="Javacsript:deleteRow(this,' + topLat + ',' + topLon + ',' + botLat + ',' + botLon + ')" class="btn btn-danger btn-block" />';
    row.insertCell(1).innerHTML= topLat;
    row.insertCell(2).innerHTML= topLon;
	row.insertCell(3).innerHTML= botLat;
	row.insertCell(4).innerHTML= botLon;
	row.insertCell(5).innerHTML= "<div contenteditable>NameThePlace!</div>";
 
}

function deleteRow(obj, lat1, lon1, lat2, lon2) {
      
    var index = obj.parentNode.parentNode.rowIndex;
    var table = document.getElementById("LocList");
    table.deleteRow(index);
	var marker1 = markers[lat1 + '_' + lon1]; // find marker
    removeMarker(marker1, lat1 + '_' + lon1); // remove it
	
	var marker2 = markers[lat2 + '_' + lon2]; // find marker
    removeMarker(marker2, lat2 + '_' + lon2); // remove it
	
	var poly = polys[lat1 + '_' + lon1];
    removePoly(poly, lat2 + '_' + lon2); // remove it
}

function removePoly(poly, polyId){
	poly.setMap(null);
	delete polys[polyId];
}

function removeMarker(marker, markerId) {
    marker.setMap(null); // set markers setMap to null to remove it from map
    delete markers[markerId]; // delete marker instance from markers object
}

function printXml() {
	var table = document.getElementById("LocList");
	var xml = "";
	for (var i = 0, row; row = table.rows[i]; i++) {
		if(row.cells[1].textContent != "TopLat"){
			xml += "<loc ";
			for (var j = 0, col; col = row.cells[j]; j++) {
				switch(j){
					case 1:
						xml += 'topLat="' + col.textContent + '" ';
						break;
					case 2:
						xml += 'topLon="' + col.textContent + '" ';
						break;
					case 3:
						xml += 'botLat="' + col.textContent + '" ';
						break;
					case 4:
						xml += 'botLon="' + col.textContent + '" ';
						break;
					case 5:
						xml += 'value="' + col.textContent + '" ';
						xml += '/>';
						break;
				
				}
		   }
		}  
	}	
	var xmlhttp = new XMLHttpRequest();

	xmlhttp.onreadystatechange = function() {
		if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
			var serverResponse = xmlhttp.responseText;
			document.getElementById("resultXMLURL").innerHTML = serverResponse;
			window.prompt("Copy to clipboard: Ctrl+C, Enter", serverResponse);
		}
	}

	xmlhttp.open("GET", "http://halapuu.host56.com/pn/GPSrulesPost.php?rules=" + encodeURI(xml), true);
	xmlhttp.send();	
}

google.maps.event.addDomListener(window, 'load', initialize);
</script>
</head>

<body>
<div id="googleMap" style="width:800px;height:600px;" class="center-block"></div>

<div id="resultTag">
	<h1 class="text-center">Result:</h1>
</div>
<div id="resultXMLURL" class="text-center bg-info"> 
	<p>Generated result XML will appear here!</p>
</div>

<div id="table" >
	<table id="LocList" class="table table-striped" border="1" cellpadding="2">
		<tr>
			<td>&nbsp;</td>
			<td><b>TopLat</b></td>
			<td><b>TopLon</b></td>
			<td><b>BotLat</b></td>
			<td><b>BotLon</b></td>
			<td><b>Name</b></td>
			<td><b><button onClick="printXml()" class="btn btn-success btn-block">CreateXML</button> </b></td>;

		</tr>
	</table>
</div>
</body>
</html>
